name: Update POM Versions

on:
  workflow_dispatch:

jobs:
  update-pom-version:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Find and update POM versions
      run: |
        # Create a new branch
        BRANCH_NAME="update-pom-versions-$(date +%Y%m%d%H%M%S)"
        git checkout -b "$BRANCH_NAME"

        # Find and update all <version> elements in pom.xml files
        find . -name "pom.xml" | while read -r POM_FILE; do
          sed -i -E 's/(<version>[0-9]+\.[0-9]+)\.([0-9]+)(-SNAPSHOT<\/version>)/echo \1.$((\2 + 1))\3/e' "$POM_FILE"
          NEW_VERSION=$(grep -oP '(?<=<version>)[0-9]+\.[0-9]+\.[0-9]+(?=-SNAPSHOT<\/version>)' "$POM_FILE" | head -n 1)
        done

        # Commit the changes with the new version in the message
        git config user.name "datalogics-devauto"
        git config user.email "datalogics-devauto@datalogics.com"
        git add .
        git commit -m "Update minor version to $NEW_VERSION in all pom.xml files (Version: $NEW_VERSION)"

        # Push the branch to origin
        git push origin "$BRANCH_NAME"

    - name: Create a pull request
      uses: peter-evans/create-pull-request@v5
      with:
        branch: "$BRANCH_NAME"
        title: "Update minor version in all pom.xml files"
        body: "This pull request updates the minor version in all pom.xml files by incrementing it by one."
        labels: "automated-update"